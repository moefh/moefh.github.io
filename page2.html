<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="alternate" href="/atom.xml" title="moefh.github.io" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="shortcut icon" href="/favicon.png">
  <title>moefh.github.io</title>
</head>
<body>
  <div class="logo"></div>
  <div class="header">
    <div class="header-nav-left">
      <a href="/">Home</a>
      <a href="/archives">Archives</a>
      <a href="/about">About</a>
    </div>
    <div class="header-nav-right">
      <a href="/atom.xml"><img class="rss-icon" src="/css/images/rss.png"></a>
    </div>
    <div class="header-title"><a href="/">moefh.github.io</a></div>
    <div class="header-subtitle">The Magic Smoke Has Left the Building</div>
  </div>


<div class="content">

<div class="content-left">

<div class="post">
  <div class="post-title"><a href="/2021/04/17/Porting-Loser-Corps-to-the-ESP32-Part-5">Porting Loser Corps to the ESP32 - Part 5</a></div>
  <div class="post-date">2021-04-17</div>
  <div class="post-content">
<p>
<i>More progress in porting Loser Corps to the ESP32 (see <a href="/tags/loser-corps">all posts about the port</a>).</i>
</p>

<p>
This is just a quick update: I have added shooting to the game.  You
shoot by pressing â‘¡ in the Wiimote (or <code>D</code> in the Arduino joystick).
There can be at most 14 shots active at once, and they do nothing but
fly in a straight line until they hit a wall or the edge of the map.
</p>

<span class="image"><img width="640" height="480" src="/2021/04/17/Porting-Loser-Corps-to-the-ESP32-Part-5/shot.jpg"><span class="image-caption">Scheenshot of projectile (the camera doesn't like moving objects,<br>in
 reality it's less blurry than shown
 here)</span></span>

<p>
I also ported the game to use the ESP-IDF framework (as opposed to the
Arduino framework, which originally used).  I'm trying to see if I can
decrease the memory used by the WiFi system so the game can use full
320x240 resolution while in networked mode, and the EDP-IDF framework
has lots of configuration options.  I haven't made much progress with
it yet: I was just recently able to make the game run at full speed,
after finding that I have to set not ony the processor clock to 240MHz
but also the flash SPI clock to 80MHz (apparently the flash speed is a
bottleneck, which is not surprising since we copy images directly from
flash to the framebuffer).
</p>

<p>
As usual, the source is on
<a href="https://github.com/moefh/esp32-loser">Github</a> (I realize I haven't
written this before, so from now on I'll start adding this link to
every post).
</p>
  </div>
  <div class="post-tags">
    <a href="/tags/esp32">#esp32</a>
    <a href="/tags/loser-corps">#loser-corps</a>
    <a href="/tags/vga">#vga</a>
  </div>
</div>
<div class="post">
  <div class="post-title"><a href="/2021/04/04/Porting-Loser-Corps-to-the-ESP32-Part-4">Porting Loser Corps to the ESP32 - Part 4</a></div>
  <div class="post-date">2021-04-04</div>
  <div class="post-content">
<p>
<i>More progress in porting Loser Corps to the ESP32 (see <a href="/tags/loser-corps">all posts about the port</a>).</i>
</p>

<p>
Working on the game network code, I was able to make two players (each
running their own game a separate ESP32) see each other's characters:
</p>

<span class="image"><img width="640" height="480" src="/2021/04/04/Porting-Loser-Corps-to-the-ESP32-Part-4/loser-net1.jpg"><span class="image-caption">First player (using the Arduino Joystick)</span></span>

<span class="image"><img width="640" height="480" src="/2021/04/04/Porting-Loser-Corps-to-the-ESP32-Part-4/loser-net2.jpg"><span class="image-caption">Second player (using the Wiimote).</span></span>

<p>
They're using
<a href="https://www.espressif.com/en/products/software/esp-now/overview">ESP-NOW</a>
(a protocol made by Espressif, the makers of ESP32) to communicate.
Currently code is very simple, it's really just a proof-of-concept.
Each ESP32 keeps broadcasting messages containing its character's
position and frame.  When it receives a message, it puts a second
character at the received location with the received frame to
represent the remote player.
</p>

<p>
The network part was much easier than expected, I got it running a
couple of hours after I was able to get WiFi running inside the game
(I had researched how to send and receive messages using ESP-NOW prior
to that).  The hard part was freeing enough memory to get the WiFi
system to start in the first place.  If you look closely at the
monitors in the photos, you can see that the image's borders are cut
at the sides: the drawing area is only 240x240 pixels (as opposed to
the usual 320x240).  The monitor still thinks it's using the old
resolution, in effect what I did was increase the horizontal front-
and back-porch of the VGA timing, which decreases the horizontal
resolution but keeps everything else unchanged (crucially, the hsync
timing).
</p>

<p>
That took care of the RAM, but we also had a ROM problem: with the
added WiFi library, the program binary itself ended up too big to fit
the flash (at least with the default Arduino IDE settings). So I
removed some sprites, an entire tileset (<code>castle</code>) and cut some tiles
from another tileset (<code>castle3</code>).  To do that I made the <code>conv_spr</code>
tool (in the <code>conv_img</code> directory in the Github repository) -- it's an
improvement of the tool I had made before but hadn't released.
</p>

<p>
The nice side of all that work is that now it's much easier to change
the resolution with the new VGA code.  It can also select between
using double framebuffers (as before) or a single framebuffer.  I made
that when researching ways to decrease VGA memory use -- it turns out
that the game <b>almost</b> runs well enough with a single framebuffer, but
it's not quite fast enough to draw the whole screen during
<a href="https://en.wikipedia.org/wiki/Vertical_blanking_interval">vblank</a>
(the time when the monitor is not actively drawing the image), so the
top portion of the screen gets a little messed up if we try.  That's
why the solution I chose at the end was to decrease the resolution and
keep using two framebuffers, but I kept the code to use a single
framebuffer in case I need it for another project in the future.
</p>

<p>

</p>
  </div>
  <div class="post-tags">
    <a href="/tags/esp32">#esp32</a>
    <a href="/tags/loser-corps">#loser-corps</a>
    <a href="/tags/vga">#vga</a>
    <a href="/tags/network">#network</a>
  </div>
</div>
<div class="post">
  <div class="post-title"><a href="/2021/04/02/Homemade-ESP32-VGA-Boards">Homemade ESP32 VGA Boards</a></div>
  <div class="post-date">2021-04-02</div>
  <div class="post-content">
<p>
To start experimenting with the networking code of the <a href="/2021/03/07/Porting-Loser-Corps-to-the-ESP32-Part-2">ESP32 game engine</a>, I made
a new board for the ESP32 so I can have two of them running the game
and talking to each other.  The new board was supposed to be just a
copy of the original one, but I discovered a silly mistake I made in
the original wiring: the red-high and red-low wires were reversed.
This caused quite a mess in the colors, I'm surprised I didn't notice
it before:
</p>

<span class="image"><img width="640" height="480" src="/2021/04/02/Homemade-ESP32-VGA-Boards/cmp-1.jpg"><span class="image-caption">Comparison showing that the old board has wrong red levels</span></span>

<span class="image"><img width="640" height="480" src="/2021/04/02/Homemade-ESP32-VGA-Boards/cmp-2.jpg"><span class="image-caption">Zoom in the "P"</span></span>

<span class="image"><img width="640" height="480" src="/2021/04/02/Homemade-ESP32-VGA-Boards/cmp-3.jpg"><span class="image-caption">Bridge and torch</span></span>

<span class="image"><img width="640" height="480" src="/2021/04/02/Homemade-ESP32-VGA-Boards/cmp-4.jpg"><span class="image-caption">Zoom in the torch</span></span>

<p>
The "new dac" label refers to the fixed DACs I wrote about in the <a href="/2021/03/27/Porting-Loser-Corps-to-the-ESP32-Part-3">last post</a>. I'm
not sure I can see any difference between the old an new DACs, to be
honest (my phone camera doesn't help -- its automatic color balance
messes up the colors way more than my DACs, apparently).
</p>

<p>
In any case, it's easy to see the difference between the old and new
boards. Not only the new board's images have a blue-greenish tint
overall (less red), we can also see that the red gradient in the "P"
is clearly fixed -- what should be <code>black</code>-><code>dark red</code>-><code>medium
red</code>-><code>bright red</code> was wrongly shown as <code>black</code>-><code>medium red</code>-><code>dark
red</code>-><code>bright red</code>, which is happens when the low and high bits of the
red component are swapped:
</p>

<div class="table-wrapper"><div class="table-scroll">
<table>
<tr>
<th align="left"></th><th align="left">correct gradient</th><th align="left">swapped first and second bits</th></tr>
<tr>
<td align="left">binary</td><td align="left">00 01 10 11</td><td align="left">00 10 01 11</td></tr>
<tr>
<td align="left">decimal</td><td align="left">0  1  2  3</td><td align="left">0  2  1  3</td></tr>
</table></div></div>


<p>
Of course, since we can select the ESP32 output pins any way we want,
it's easy to fix this in software by simply changing the pin
assignments in the <code>pin_config</code> array in <code>vga_game.ino</code>: just swap
<code>PIN_RED_LOW</code> and <code>PIN_RED_HIGH</code>. That's good news for me because I
don't feel like making a third board right now.
</p>

<p>
And finally, just for reference, here are all of the homemade boards
I'm using in this project:
</p>

<span class="image"><img width="640" height="480" src="/2021/04/02/Homemade-ESP32-VGA-Boards/new_board.jpg"><span class="image-caption">New board</span></span>

<span class="image"><img width="640" height="480" src="/2021/04/02/Homemade-ESP32-VGA-Boards/old_board.jpg"><span class="image-caption">Old board (notice that the red wires don't cross, unlike the blue and green ones)</span></span>

<p>
<span class="image"><img width="640" height="480" src="/2021/04/02/Homemade-ESP32-VGA-Boards/dacs.jpg"><span class="image-caption">DACs</span></span>

</p>
  </div>
  <div class="post-tags">
    <a href="/tags/esp32">#esp32</a>
    <a href="/tags/vga">#vga</a>
    <a href="/tags/perfboard">#perfboard</a>
  </div>
</div>

<div class="footer">
    <div class="page-links">
      <div class="nav-link nav-link-prev">
        <a href="/index.html">&#x2190; Previous</a>
      </div>

      <div class="nav-link nav-link-page-num">Page 2/4</div>
      
      <div class="nav-link nav-link-next">
        <a href="/page3.html">Next &#x2192;</a>
      </div>

    </div>

  <div class="copyright">Copyright (C) 2021 MoeFH</div>

</div>

</div>

<div class="content-right">
  <div class="tag-list">
    <div class="title">TAGS</div>
    <div class="tags">
      <div class="tag"><a href="/tags/arm">arm</a></div>
      <div class="tag"><a href="/tags/assembly">assembly</a></div>
      <div class="tag"><a href="/tags/esp-now">esp-now</a></div>
      <div class="tag"><a href="/tags/esp32">esp32</a></div>
      <div class="tag"><a href="/tags/i2c">i2c</a></div>
      <div class="tag"><a href="/tags/joystick">joystick</a></div>
      <div class="tag"><a href="/tags/loser-corps">loser-corps</a></div>
      <div class="tag"><a href="/tags/network">network</a></div>
      <div class="tag"><a href="/tags/nunchuk">nunchuk</a></div>
      <div class="tag"><a href="/tags/perfboard">perfboard</a></div>
      <div class="tag"><a href="/tags/stm32">stm32</a></div>
      <div class="tag"><a href="/tags/vga">vga</a></div>
      <div class="tag"><a href="/tags/wii">wii</a></div>
      <div class="tag"><a href="/tags/wiimote">wiimote</a></div>
    </div>
  </div>

  <div class="month-list">
    <div class="title">ARCHIVES</div>
    <div class="months">
      <div class="month"><a href="/archives/2021/05">May 2021</a></div>
      <div class="month"><a href="/archives/2021/04">April 2021</a></div>
      <div class="month"><a href="/archives/2021/03">March 2021</a></div>
      <div class="month"><a href="/archives/2021/02">Ferbuary 2021</a></div>
    </div>
  </div>
</div>

</div>


</body>
</html>

