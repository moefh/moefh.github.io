<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Porting Loser Corps to the ESP32 - Part 6 | moefh.github.io</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="More progress in porting Loser Corps to the ESP32 (here&#39;s part 1 of the saga). The game now runs with networking enabled while using the full 320x240 resolution:  To fit WiFi and the two 320x240 f">
<meta property="og:type" content="article">
<meta property="og:title" content="Porting Loser Corps to the ESP32 - Part 6">
<meta property="og:url" content="http://moefh.github.io/2021/05/15/Porting-Loser-Corps-to-the-ESP32-Part-6/index.html">
<meta property="og:site_name" content="moefh.github.io">
<meta property="og:description" content="More progress in porting Loser Corps to the ESP32 (here&#39;s part 1 of the saga). The game now runs with networking enabled while using the full 320x240 resolution:  To fit WiFi and the two 320x240 f">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://moefh.github.io/2021/05/15/Porting-Loser-Corps-to-the-ESP32-Part-6/photo.jpg">
<meta property="og:image" content="http://moefh.github.io/2021/05/15/Porting-Loser-Corps-to-the-ESP32-Part-6/menuconfig.png">
<meta property="article:published_time" content="2021-05-15T17:28:12.000Z">
<meta property="article:modified_time" content="2021-05-14T00:35:38.629Z">
<meta property="article:author" content="MoeFH">
<meta property="article:tag" content="esp32">
<meta property="article:tag" content="vga">
<meta property="article:tag" content="loser-corps">
<meta property="article:tag" content="network">
<meta property="article:tag" content="esp-now">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://moefh.github.io/2021/05/15/Porting-Loser-Corps-to-the-ESP32-Part-6/photo.jpg">
  
    <link rel="alternate" href="/atom.xml" title="moefh.github.io" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">moefh.github.io</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">The Magic Smoke Has Left the Building</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://moefh.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Porting-Loser-Corps-to-the-ESP32-Part-6" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/15/Porting-Loser-Corps-to-the-ESP32-Part-6/" class="article-date">
  <time class="dt-published" datetime="2021-05-15T17:28:12.000Z" itemprop="datePublished">2021-05-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Porting Loser Corps to the ESP32 - Part 6
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>More progress in porting Loser Corps to the ESP32 (<a href="/2021/02/28/Porting-Loser-Corps-to-the-ESP32/" title="here&#39;s part 1">here&#39;s part 1</a> of the saga).</p>
<p>The game now runs with networking enabled while using the full 320x240
resolution:</p>
<p><img src="/2021/05/15/Porting-Loser-Corps-to-the-ESP32-Part-6/photo.jpg" alt="Two ESP32s talking to each other via ESP-NOW, each one controlling a
character (note also the Wii Classic
Controller)"></p>
<p>To fit WiFi and the two 320x240 framebuffers in memory, I had to make
some changes: first, don’t use Bluetooth – so the Wiimote is out.
Luckily I now can use the Wii Classic Controller (as shown in the
picture) or Wii Nunchuk, so that’s not a big deal.</p>
<p>Second, I had to decrease the number of transmit and receive buffers
used by the WiFi library.  This can’t be changed in with the Arduino
Core for the ESP32, so I can’t use the Arduino IDE for this.  Using
the ESP-IDF framework, this (and a lot more) can be changed with
<code>idf.py menuconfig</code>:</p>
<p><img src="/2021/05/15/Porting-Loser-Corps-to-the-ESP32-Part-6/menuconfig.png" alt="Adjusting the number of WiFi receive buffers"></p>
<p>Thankfully it’s not too much of a hassle to use the same code with the
two APIs (which is not that surprising, since the Arduino Core is just
an added layer on top of the ESP-IDF).  The largest hurdle was to
learn how to set the CPU clock using the ESP-IDF (it’s a lot more
involved than I thought, I ended up lifting code from the Arduino
Core) and to support the Wiimote library, which uses the Bluetooth API
from the Arduino Core (so once more I lifted some code from there).</p>
<p>In the end, it was fun and I learned a little bit about FreeRTOS
(which the Arduino Core completely hides) in order to run my code on
one of the CPUs of the ESP32 and let the WiFi and other stuff use the
other one.</p>
<p>The other change in the game since the last update post was the
addition of Wii Nunchuk and Classic Controller support via I2C with my
<a target="_blank" rel="noopener" href="https://github.com/moefh/esp32-wii-nunchuk">esp32-wii-nunchuk</a>
library.</p>
<p>After plugging the library to the game code, I noticed that sometimes
the I2C read from the controller gets stuck for a little bit.  Usually
that’s not a big problem, but for this game any hiccup is really
noticeable and annoying (the engine <em>really</em> wants to run at 60fps).
So I had to add some functions to the library to run a loop that reads
the controller state in a different CPU core than the game engine, and
it ended up working really well.</p>
<p>The source code for the version of the game that uses the Arduino API
is here:
<a target="_blank" rel="noopener" href="https://github.com/moefh/esp32-loser">https://github.com/moefh/esp32-loser</a>. I
haven’t published the version using the ESP-IDF yet, but it just adds
the files that deal with Bluetooth and</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://moefh.github.io/2021/05/15/Porting-Loser-Corps-to-the-ESP32-Part-6/" data-id="ckom9hqxo0000j4yq3auvg8jr" data-title="Porting Loser Corps to the ESP32 - Part 6" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/esp-now/" rel="tag">esp-now</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/esp32/" rel="tag">esp32</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/loser-corps/" rel="tag">loser-corps</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/" rel="tag">network</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vga/" rel="tag">vga</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2021/05/14/Using-Wii-I2C-Controllers-on-the-ESP32/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Using Wii I2C Controllers on the ESP32</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm/" rel="tag">arm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/assembly/" rel="tag">assembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/esp-now/" rel="tag">esp-now</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/esp32/" rel="tag">esp32</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/i2c/" rel="tag">i2c</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/joystick/" rel="tag">joystick</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/loser-corps/" rel="tag">loser-corps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/" rel="tag">network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nunchuk/" rel="tag">nunchuk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/perfboard/" rel="tag">perfboard</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stm32/" rel="tag">stm32</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vga/" rel="tag">vga</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wii/" rel="tag">wii</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wiimote/" rel="tag">wiimote</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/arm/" style="font-size: 10px;">arm</a> <a href="/tags/assembly/" style="font-size: 10px;">assembly</a> <a href="/tags/esp-now/" style="font-size: 10px;">esp-now</a> <a href="/tags/esp32/" style="font-size: 20px;">esp32</a> <a href="/tags/i2c/" style="font-size: 10px;">i2c</a> <a href="/tags/joystick/" style="font-size: 10px;">joystick</a> <a href="/tags/loser-corps/" style="font-size: 15px;">loser-corps</a> <a href="/tags/network/" style="font-size: 12.5px;">network</a> <a href="/tags/nunchuk/" style="font-size: 10px;">nunchuk</a> <a href="/tags/perfboard/" style="font-size: 10px;">perfboard</a> <a href="/tags/stm32/" style="font-size: 10px;">stm32</a> <a href="/tags/vga/" style="font-size: 17.5px;">vga</a> <a href="/tags/wii/" style="font-size: 10px;">wii</a> <a href="/tags/wiimote/" style="font-size: 10px;">wiimote</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/05/15/Porting-Loser-Corps-to-the-ESP32-Part-6/">Porting Loser Corps to the ESP32 - Part 6</a>
          </li>
        
          <li>
            <a href="/2021/05/14/Using-Wii-I2C-Controllers-on-the-ESP32/">Using Wii I2C Controllers on the ESP32</a>
          </li>
        
          <li>
            <a href="/2021/04/17/Porting-Loser-Corps-to-the-ESP32-Part-5/">Porting Loser Corps to the ESP32 - Part 5</a>
          </li>
        
          <li>
            <a href="/2021/04/04/Porting-Loser-Corps-to-the-ESP32-Part-4/">Porting Loser Corps to the ESP32 - Part 4</a>
          </li>
        
          <li>
            <a href="/2021/04/02/Homemade-ESP32-VGA-Boards/">Homemade ESP32 VGA Boards</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 MoeFH<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>