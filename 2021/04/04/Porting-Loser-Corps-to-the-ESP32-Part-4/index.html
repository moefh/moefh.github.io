<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Porting Loser Corps to the ESP32 - Part 4 | moefh.github.io</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="More progress in porting Loser Corps to the ESP32 (here&#39;s part 1 of the saga). Working on the game network code, I was able to make two players (each running their own game a separate ESP32) see e">
<meta property="og:type" content="article">
<meta property="og:title" content="Porting Loser Corps to the ESP32 - Part 4">
<meta property="og:url" content="http://moefh.github.io/2021/04/04/Porting-Loser-Corps-to-the-ESP32-Part-4/index.html">
<meta property="og:site_name" content="moefh.github.io">
<meta property="og:description" content="More progress in porting Loser Corps to the ESP32 (here&#39;s part 1 of the saga). Working on the game network code, I was able to make two players (each running their own game a separate ESP32) see e">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://moefh.github.io/2021/04/04/Porting-Loser-Corps-to-the-ESP32-Part-4/loser-net1.jpg">
<meta property="og:image" content="http://moefh.github.io/2021/04/04/Porting-Loser-Corps-to-the-ESP32-Part-4/loser-net2.jpg">
<meta property="article:published_time" content="2021-04-04T03:10:58.000Z">
<meta property="article:modified_time" content="2021-04-04T04:07:20.041Z">
<meta property="article:author" content="MoeFH">
<meta property="article:tag" content="esp32">
<meta property="article:tag" content="vga">
<meta property="article:tag" content="loser-corps">
<meta property="article:tag" content="network">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://moefh.github.io/2021/04/04/Porting-Loser-Corps-to-the-ESP32-Part-4/loser-net1.jpg">
  
    <link rel="alternate" href="/atom.xml" title="moefh.github.io" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">moefh.github.io</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">The Magic Smoke Has Left the Building</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://moefh.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Porting-Loser-Corps-to-the-ESP32-Part-4" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/04/Porting-Loser-Corps-to-the-ESP32-Part-4/" class="article-date">
  <time class="dt-published" datetime="2021-04-04T03:10:58.000Z" itemprop="datePublished">2021-04-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Porting Loser Corps to the ESP32 - Part 4
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>More progress in porting Loser Corps to the ESP32 (<a href="/2021/02/28/Porting-Loser-Corps-to-the-ESP32/" title="here&#39;s part 1">here&#39;s part 1</a> of the saga).</p>
<p>Working on the game network code, I was able to make two players (each
running their own game a separate ESP32) see each other’s characters:</p>
<p><img src="/2021/04/04/Porting-Loser-Corps-to-the-ESP32-Part-4/loser-net1.jpg" alt="First player (using the Arduino Joystick)"></p>
<p><img src="/2021/04/04/Porting-Loser-Corps-to-the-ESP32-Part-4/loser-net2.jpg" alt="Second player (using the Wiimote)."></p>
<p>They’re using
<a target="_blank" rel="noopener" href="https://www.espressif.com/en/products/software/esp-now/overview">ESP-NOW</a>
(a protocol made by Espressif, the makers of ESP32) to communicate.
Currently code is very simple, it’s really just a proof-of-concept.
Each ESP32 keeps broadcasting messages containing its character’s
position and frame.  When it receives a message, it puts a second
character at the received location with the received frame to
represent the remote player.</p>
<p>The network part was much easier than expected, I got it running a
couple of hours after I was able to get WiFi running inside the game
(I had researched how to send and receive messages using ESP-NOW prior
to that).  The hard part was freeing enough memory to get the WiFi
system to start in the first place.  If you look closely at the
monitors in the photos, you can see that the image’s borders are cut
at the sides: the drawing area is only 240x240 pixels (as opposed to
the usual 320x240).  The monitor still thinks it’s using the old
resolution, in effect what I did was increase the horizontal front-
and back-porch of the VGA timing, which decreases the horizontal
resolution but keeps everything else unchanged (crucially, the hsync
timing).</p>
<p>That took care of the RAM, but we also had a ROM problem: with the
added WiFi library, the program binary itself ended up too big to fit
the flash (at least with the default Arduino IDE settings). So I
removed some sprites, an entire tileset (<code>castle</code>) and cut some tiles
from another tileset (<code>castle3</code>).  To do that I made the <code>conv_spr</code>
tool (in the <code>conv_img</code> directory in the Github repository) – it’s an
improvement of the tool I had made before but hadn’t released.</p>
<p>The nice side of all that work is that now it’s much easier to change
the resolution with the new VGA code.  It can also select between
using double framebuffers (as before) or a single framebuffer.  I made
that when researching ways to decrease VGA memory use – it turns out
that the game <em>almost</em> runs well enough with a single framebuffer, but
it’s not quite fast enough to draw the whole screen during
<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Vertical_blanking_interval">vblank</a>
(the time when the monitor is not actively drawing the image), so the
top portion of the screen gets a little messed up if we try.  That’s
why the solution I chose at the end was to decrease the resolution and
keep using two framebuffers, but I kept the code to use a single
framebuffer in case I need it for another project in the future.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://moefh.github.io/2021/04/04/Porting-Loser-Corps-to-the-ESP32-Part-4/" data-id="ckn2lf38h0000h0yqcm6yaauk" data-title="Porting Loser Corps to the ESP32 - Part 4" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/esp32/" rel="tag">esp32</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/loser-corps/" rel="tag">loser-corps</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/" rel="tag">network</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vga/" rel="tag">vga</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/04/17/Porting-Loser-Corps-to-the-ESP32-Part-5/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Porting Loser Corps to the ESP32 - Part 5
        
      </div>
    </a>
  
  
    <a href="/2021/04/02/Homemade-ESP32-VGA-Boards/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Homemade ESP32 VGA Boards</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm/" rel="tag">arm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/assembly/" rel="tag">assembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/esp32/" rel="tag">esp32</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/i2c/" rel="tag">i2c</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/joystick/" rel="tag">joystick</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/loser-corps/" rel="tag">loser-corps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/" rel="tag">network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nunchuk/" rel="tag">nunchuk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/perfboard/" rel="tag">perfboard</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stm32/" rel="tag">stm32</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vga/" rel="tag">vga</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wii/" rel="tag">wii</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wiimote/" rel="tag">wiimote</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/arm/" style="font-size: 10px;">arm</a> <a href="/tags/assembly/" style="font-size: 10px;">assembly</a> <a href="/tags/esp32/" style="font-size: 20px;">esp32</a> <a href="/tags/i2c/" style="font-size: 10px;">i2c</a> <a href="/tags/joystick/" style="font-size: 10px;">joystick</a> <a href="/tags/loser-corps/" style="font-size: 13.33px;">loser-corps</a> <a href="/tags/network/" style="font-size: 10px;">network</a> <a href="/tags/nunchuk/" style="font-size: 10px;">nunchuk</a> <a href="/tags/perfboard/" style="font-size: 10px;">perfboard</a> <a href="/tags/stm32/" style="font-size: 10px;">stm32</a> <a href="/tags/vga/" style="font-size: 16.67px;">vga</a> <a href="/tags/wii/" style="font-size: 10px;">wii</a> <a href="/tags/wiimote/" style="font-size: 10px;">wiimote</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/05/15/Using-Wii-I2C-Controllers-on-the-ESP32/">Using Wii I2C Controllers on the ESP32</a>
          </li>
        
          <li>
            <a href="/2021/04/17/Porting-Loser-Corps-to-the-ESP32-Part-5/">Porting Loser Corps to the ESP32 - Part 5</a>
          </li>
        
          <li>
            <a href="/2021/04/04/Porting-Loser-Corps-to-the-ESP32-Part-4/">Porting Loser Corps to the ESP32 - Part 4</a>
          </li>
        
          <li>
            <a href="/2021/04/02/Homemade-ESP32-VGA-Boards/">Homemade ESP32 VGA Boards</a>
          </li>
        
          <li>
            <a href="/2021/03/27/Porting-Loser-Corps-to-the-ESP32-Part-3/">Porting Loser Corps to the ESP32 - Part 3</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 MoeFH<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>